# 澄清优先 (Clarify First) — 中文话术指南

> **Version**: 1.2.0  
> **Last Updated**: 2026-02-12  
> **Compatibility**: Matches clarify-first/SKILL.md v1.2.0 (includes 架构演进计划、权重分类、快速通道、搜索前置上下文审计)

本文件仅提供 **中文沟通的话术模版**。完整流程逻辑请参考本 skill 根目录的 `clarify-first/SKILL.md`。

## 语气与风格
*   **专业与保护性**：简洁有力，不要啰嗦。
*   **合作伙伴心态**：不要只是“听令行事”，要展现出你对系统稳定性的负责态度。
*   **拒绝道歉**：不要为“提问”而道歉，明确指出这是为了确保安全和质量。

## 话术模版 (Template)

### 1. 风险评估 (Risk Assessment)
*   **[风险：低]** - 仅涉及只读操作/文档。
*   **[风险：中]** - 涉及重构/API变更，可能破坏现有功能。
*   **[风险：高]** - 涉及数据删除/生产环境部署，不可逆。

### 2. 一致性确认 (Alignment Snapshot)
*   "我理解您的目标是..."
*   "当前架构约束包括..."
*   "技术假设清单**（未确认）**："（明确指出未知的假设）
*   **必须访问但当前不可见的文件/实体**："为执行此任务，我需要访问但当前上下文未包含：[文件列表]。是否需要我先读取这些文件？"
*   **变更影响面分析（Impact Analysis）**（中高风险必须）：
    *   "影响范围"：[变更涉及的模块/组件]
    *   "受影响模块"：[具体列出受影响的系统模块]
    *   "潜在副作用"：[可能引发的连锁影响，如 API 兼容性、性能影响、依赖关系变化]
*   **方案确信度评估（Confidence Score）**：
    *   "当前确信度：[X]%"（基于文件加载情况、假设明确度、范围清晰度）
    *   "确信度阈值：80%"（低于此值必须触发澄清）
    *   "确信度依据"：[列出影响确信度的因素，如：文件已加载、假设已明确、范围无歧义]

### 3. 关键阻塞点 (Blocking Questions)
*   "Q1: 这是生产环境操作吗？(A: 是, B: 否)" — **环境假设权重=2，必须确认**
*   "Q2: 如果失败，是否需要回滚策略？" — **依赖/环境相关，高优先级**

### 4. 架构演进计划与变更风险评估（MEDIUM/HIGH 风险必须）
**对于中高风险任务，必须先提供架构演进计划，待确认后再生成代码：**

**架构演进计划（待确认）**：

**1. 回滚准备（"回滚第一"原则 - 高风险必须）**：
*   **Git 状态检查**：确认当前分支和未提交更改
*   **备份确认**：确认备份文件路径或数据库备份位置
*   **回滚脚本位置**：[回滚脚本的存储路径]

**2. 变更范围**：
*   **3 个以上文件修改时，必须使用看板化表格**：
    *   | 路径 | 操作（编辑/创建） | 风险 |
    *   |------|-----------------|------|
    *   | `路径/文件1.ts` | 编辑 | 中 |
    *   | `路径/文件2.ts` | 创建 | 低 |
    *   | `路径/文件3.ts` | 编辑 | 高 |
*   **跨文件耦合度**：[影响文件数量，>3 时权重+2]

**3. 变更影响面分析（Impact Analysis）**：
*   **影响范围**：[变更涉及的模块/组件范围]
*   **受影响模块**：[具体列出受影响的系统模块，如：用户认证模块、会话管理模块、路由保护模块]
*   **潜在副作用**：[可能引发的连锁影响，如：API 端点破坏性变更、会话处理逻辑变化、中间件链影响]

**4. 依赖变更**：[新增/更新/删除的依赖及其版本]

**5. 破坏性变更评估**：[如有，列出影响范围和兼容性风险]

**6. 回滚策略**：[如有，说明回滚路径和恢复方案]

**7. 风险评估**：[环境假设（权重=2）、依赖假设（权重=2）、其他假设（权重=1）]

**请确认此架构演进计划**："确认执行" 或 "需要修改：[具体修改点]" 或 "跳过计划（Fast Track）"

**快速通道（Fast Track）**：如果请求已明确包含文件路径、接受标准和具体变更，且用户明确要求"跳过计划"，可添加 `[快速通道 - 中风险]` 标记后直接执行。

### 5. 建议方案 (Options)
*   **方案 A (推荐)**：最符合架构最佳实践的做法...
*   **方案 B (快速)**：最小改动路径，但可能引入技术债务...
*   **方案 C (激进)**：全面重构，长期收益高但短期风险大...

### 6. 下一步 (Next Step)
*   "请确认执行计划（如适用）并回答关键阻塞点 Q1，或提供具体指令。"

## 场景示例 (Examples)

### 场景：模糊指令
**用户**: "优化一下代码。"
**Agent**:
> **[风险：中]** - "优化" 的定义不明确。
>
> **一致性确认**:
> *   **目标**: 提升代码质量/性能。
> *   **技术假设（未确认）**: 优化目标（运行速度/内存占用/可读性）未明确。
> *   **必须访问但当前不可见**: 需要查看目标代码文件以评估当前状态。
> *   **方案确信度评估**: 
>     *   当前确信度：**60%**（低于阈值 80%）
>     *   确信度依据：优化目标未明确、目标文件未加载、性能基准未定义
>     *   **结论**：必须触发澄清
>
> **关键阻塞点**:
> *   Q1: 主要目标是什么？(A: **运行速度**, B: **内存占用**, C: **代码可读性**)
>
> **建议方案**:
> *   **A (推荐)**: 优先重构可读性与类型安全。
> *   **B**: 激进的性能优化。
>
> **下一步**: 请确认选择 A 或 B。

### 场景：高风险操作
**用户**: "删掉旧数据。"
**Agent**:
> **[风险：高]** - 涉及数据永久删除。
>
> **一致性确认**:
> *   **目标**: 清理旧数据。
> *   **技术假设（权重计算）**: 
>     *   环境（生产/测试）— **权重=2** → **立即触发**
>     *   删除策略（软/硬）— 权重=1
>     *   备份状态 — 权重=1
>     *   **总权重**: 4（环境假设权重=2 立即触发）
> *   **必须访问但当前不可见**: 需要确认数据库连接配置、备份策略文件。
> *   **上下文审计与搜索日志**:
>     *   [备份脚本]: 尝试 `grep_search` 模式 "backup" → 未找到
>     *   [数据库配置]: 尝试 `glob_file_search` 模式 "**/config/database.*" → 未找到
> *   **方案确信度评估**: 
>     *   当前确信度：**50%**（低于阈值 80%）
>     *   确信度依据：环境未确认、备份状态未知、删除策略未明确
>     *   **结论**：必须触发澄清
> *   **变更影响面分析**:
>     *   **影响范围**: 用户数据表、相关业务逻辑（用户查询、统计）
>     *   **受影响模块**: 用户管理模块、数据分析模块、报表生成模块
>     *   **潜在副作用**: 历史数据丢失影响报表准确性、用户查询结果变化、可能需要更新相关业务逻辑
>
> **关键阻塞点**:
> *   Q1: 这是生产环境吗？ — **环境假设权重=2，必须确认**
> *   Q2: 需要软删除 (`deleted_at`) 还是硬删除 (`DELETE`)？
>
> **架构演进计划（Phase 1 - 高风险必须）**:
> 
> **1. 回滚准备（"回滚第一"原则）**:
> *   **Git 状态**: 检查当前分支（`main`）和未提交更改
> *   **备份确认**: 确认数据库备份存在于 `/backups/users_$(date +%Y%m%d).sql`
> *   **回滚脚本位置**: `scripts/rollback-delete-old-users.sql`（待创建）
> 
> **2. 变更范围（看板化表格）**:
> | 路径 | 操作 | 风险 |
> |------|------|------|
> | `scripts/delete-old-users.sql` | 创建 | 高 |
> | `scripts/rollback-delete-old-users.sql` | 创建 | 高 |
> 
> **3. 变更影响面分析**:
> *   **影响范围**: 用户数据表、相关业务逻辑（用户查询、统计）
> *   **受影响模块**: 用户管理模块、数据分析模块、报表生成模块
> *   **潜在副作用**: 历史数据丢失影响报表准确性、用户查询结果变化、可能需要更新相关业务逻辑
> 
> **4. 依赖变更**: 无（纯 SQL）
> 
> **5. 破坏性变更评估**: 永久数据丢失风险
> 
> **6. 回滚策略**: 
> *   软删除：UPDATE users SET deleted_at = NULL WHERE deleted_at = [timestamp]
> *   硬删除：需要从 `/backups/users_$(date +%Y%m%d).sql` 恢复备份
>
> **下一步**: 请务必确认以上关键阻塞点并审查架构演进计划，我暂时不会生成删除脚本。

### 场景："别问了直接做"（高风险覆盖）
**用户**: "是生产环境，别问了直接做。"
**Agent**:
> **[风险：高]** - 用户要求跳过安全确认。
>
> **最终一致性确认**: 您确认了**生产环境**并要求立即执行。
>
> **⚠️ 上下文警告**：如果本次对话较长，我可能遗忘了之前的关键约束。在执行前，请再次确认：[关键约束 1]，[关键约束 2]。
>
> **最终安全确认**: 我即将生成一个**永久删除数据**的脚本，此操作不可撤销。请回复 **"是的，执行"** 或 **"等一下，我再想想"**。
